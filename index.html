<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chat (Customer)</title>

  <style>
    :root{
      --bg: #efeae2;
      --panel: #ffffff;
      --text: #111;
      --muted: #667085;
      --me: #dcf8c6;
      --them: #ffffff;
      --border: #e5e7eb;
      --accent: #25d366;
      --btn: #0b74ff;
      --danger: #ef4444;
      --dark: #111827;
    }

    body{
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    #chat{
      height: 100dvh;
      display: flex;
      flex-direction: column;
    }

    #topbar{
      padding: 10px 12px;
      background: var(--panel);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    #status{
      font-size: 13px;
      color: var(--muted);
    }

    #topActions{
      display: inline-flex;
      align-items: center;
      gap: 8px;
      flex: 0 0 auto;
      white-space: nowrap;
    }

    #callState{
      font-size: 12px;
      color: var(--muted);
      user-select: none;
    }

    #messages{
      flex: 1;
      overflow-y: auto;
      padding: 14px 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .bubble{
      max-width: 72%;
      padding: 10px 12px;
      border-radius: 14px;
      line-height: 1.3;
      word-wrap: break-word;
      box-shadow: 0 1px 0 rgba(0,0,0,.06);
      box-sizing: border-box;
    }

    .bubble.me{
      align-self: flex-end;
      background: var(--me);
      border-top-right-radius: 6px;
    }

    .bubble.them{
      align-self: flex-start;
      background: var(--them);
      border-top-left-radius: 6px;
    }

    .meta{
      margin-top: 6px;
      font-size: 11px;
      color: rgba(0,0,0,.55);
      text-align: right;
      user-select: none;
    }

    .title{
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
      user-select: none;
    }

    .group{
      display: inline-block;
      max-width: 72%;
    }
    .group.me{ align-self: flex-end; }
    .group.them{ align-self: flex-start; }

    .bubble.inGroup{
      max-width: 100%;
      width: 100%;
      box-sizing: border-box;
    }

    .group .bubble.inGroup{ margin: 0; }
    .group .bubble.inGroup + .bubble.inGroup{
      margin-top: 2px;
      box-shadow: none;
    }

    .group.me .bubble.inGroup:first-child{ border-bottom-right-radius: 6px; }
    .group.me .bubble.inGroup:last-child{  border-top-right-radius: 6px; }

    .group.them .bubble.inGroup:first-child{ border-bottom-left-radius: 6px; }
    .group.them .bubble.inGroup:last-child{  border-top-left-radius: 6px; }

    audio{
      width: 320px;
      max-width: 100%;
      height: 36px;
      display: block;
    }

    .tx > summary{
      cursor: pointer;
      user-select: none;
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      list-style: none;
    }
    .tx > summary::-webkit-details-marker{ display: none; }
    .tx > summary::before{
      content: "â–¸";
      display: inline-block;
      transition: transform 0.12s ease;
    }
    .tx[open] > summary::before{ transform: rotate(90deg); }

    .transcript{
      margin-top: 6px;
      white-space: pre-wrap;
    }

    #composer{
      padding: 10px;
      background: var(--panel);
      border-top: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: nowrap;
    }

    #msg{
      flex: 1 1 auto;
      min-width: 0;
      font-size: 15px;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 999px;
      outline: none;
    }

    .iconBtn{
      width: 40px;
      height: 40px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      line-height: 1;
      user-select: none;
      flex: 0 0 auto;
      color: #fff;
    }

    #uploadBtn{ background: var(--btn); }
    #send{ background: var(--accent); }

    #acceptBtn{ background: var(--accent); }
    #rejectBtn{ background: var(--danger); }
    #hangupBtn{ background: var(--danger); }

    .iconBtn:disabled{
      opacity: 0.6;
      cursor: not-allowed;
    }

    #file{
      position: absolute;
      left: -9999px;
      width: 1px;
      height: 1px;
      opacity: 0.01;
    }

    /* Incoming call banner */
    #incoming{
      display: none;
      padding: 10px 12px;
      background: var(--panel);
      border-bottom: 1px solid var(--border);
      gap: 10px;
      align-items: center;
      justify-content: space-between;
    }

    #incomingText{
      font-size: 13px;
      color: var(--text);
    }

    #incomingBtns{
      display: inline-flex;
      gap: 8px;
      flex: 0 0 auto;
    }

    @media (max-width: 520px){
      #messages{ padding: 10px 8px; gap: 6px; }
      .bubble{ max-width: 92%; }
      .group{ max-width: 92%; }
      .iconBtn{ width: 38px; height: 38px; }
      #topbar{ gap: 8px; }
      #topActions{ gap: 6px; }
    }
  </style>
</head>

<body>
  <div id="chat">
    <div id="topbar">
      <div>
        <div style="font-weight:700">Chat</div>
        <div id="status">Disconnected</div>
        <div id="callState">No call</div>
      </div>

      <div id="topActions">
        <div style="font-size:12px;color:var(--muted)">
          Room: <span id="roomLabel"></span> | Role: <span id="roleLabel"></span>
        </div>
        <button id="hangupBtn" class="iconBtn" title="Hang up" disabled>âœ•</button>
      </div>
    </div>

    <div id="incoming">
      <div id="incomingText">Incoming callâ€¦</div>
      <div id="incomingBtns">
        <button id="acceptBtn" class="iconBtn" title="Accept">âœ“</button>
        <button id="rejectBtn" class="iconBtn" title="Reject">âœ•</button>
      </div>
    </div>

    <div id="messages" aria-live="polite"></div>

    <div id="composer">
      <input id="msg" placeholder="Type a messageâ€¦" autocomplete="off" />
      <input id="file" type="file" />
      <button id="uploadBtn" class="iconBtn" title="Upload">ðŸ“Ž</button>
      <button id="send" class="iconBtn" title="Send">âž¤</button>
    </div>

    <audio id="remoteAudio" autoplay></audio>
  </div>

  <script src="https://chat-server-orzm.onrender.com/socket.io/socket.io.js"></script>

  <script>
    const SERVER_URL = "https://chat-server-orzm.onrender.com";
    const room = "room-123";
    const role = "B";
    const UPLOAD_BASE = "https://natisha-flamy-lonely.ngrok-free.dev";

    document.getElementById("roomLabel").textContent = room;
    document.getElementById("roleLabel").textContent = role;

    const messagesEl = document.getElementById("messages");
    const statusEl = document.getElementById("status");
    const callStateEl = document.getElementById("callState");

    const inputEl = document.getElementById("msg");
    const sendBtn = document.getElementById("send");
    const fileEl = document.getElementById("file");
    const uploadBtn = document.getElementById("uploadBtn");

    const incomingEl = document.getElementById("incoming");
    const acceptBtn = document.getElementById("acceptBtn");
    const rejectBtn = document.getElementById("rejectBtn");
    const hangupBtn = document.getElementById("hangupBtn");
    const remoteAudio = document.getElementById("remoteAudio");

    const socket = io(SERVER_URL);

    function setStatus(text) { statusEl.textContent = text; }
    function setCallState(text) { callStateEl.textContent = text; }
    function formatTime(ts) {
      return new Date(ts).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
    }

    function addBubble(side, text, ts = Date.now()) {
      const bubble = document.createElement("div");
      bubble.className = `bubble ${side}`;

      const body = document.createElement("div");
      body.textContent = text;

      const meta = document.createElement("div");
      meta.className = "meta";
      meta.textContent = formatTime(ts);

      bubble.appendChild(body);
      bubble.appendChild(meta);

      messagesEl.appendChild(bubble);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function addMediaGroup(side, media, ts = Date.now()) {
      const group = document.createElement("div");
      group.className = `group ${side}`;

      const voice = document.createElement("div");
      voice.className = `bubble ${side} inGroup`;

      const title = document.createElement("div");
      title.className = "title";
      title.textContent = "Voice message";

      const audio = document.createElement("audio");
      audio.controls = true;
      audio.preload = "none";
      audio.src = media.audioUrl;

      const meta = document.createElement("div");
      meta.className = "meta";
      meta.textContent = formatTime(ts);

      voice.appendChild(title);
      voice.appendChild(audio);
      voice.appendChild(meta);
      group.appendChild(voice);

      if (media.transcript) {
        const tr = document.createElement("div");
        tr.className = `bubble ${side} inGroup`;

        const details = document.createElement("details");
        details.className = "tx";

        const summary = document.createElement("summary");
        summary.textContent = "Transcript";

        const t = document.createElement("div");
        t.className = "transcript";
        t.textContent = media.transcript;

        details.appendChild(summary);
        details.appendChild(t);

        tr.appendChild(details);
        group.appendChild(tr);
      }

      messagesEl.appendChild(group);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function sendCurrent() {
      const text = inputEl.value.trim();
      if (!text) return;

      addBubble("me", text);
      socket.emit("chat", { room, text });
      inputEl.value = "";
      inputEl.focus();
    }

    async function uploadSelectedFile() {
      if (!fileEl.files || fileEl.files.length === 0) return;

      uploadBtn.disabled = true;
      try {
        const fd = new FormData();
        fd.append("file", fileEl.files[0]);

        const resp = await fetch(`${UPLOAD_BASE}/upload`, { method: "POST", body: fd });
        if (!resp.ok) throw new Error(`Upload failed: HTTP ${resp.status}`);

        const out = await resp.json();

        addBubble("me", `Uploaded: ${out.originalName} (${out.bytes} bytes)`);
        socket.emit("chat", { room, text: `File uploaded: ${out.originalName}` });
      } catch (err) {
        addBubble("me", `Upload error: ${err.message}`);
      } finally {
        fileEl.value = "";
        uploadBtn.disabled = false;
      }
    }

    // ---------------- WebRTC audio call (Customer = callee) ----------------
    let pc = null;
    let localStream = null;
    let pendingIce = [];
    let inCall = false;

    let pendingOffer = null;

    const rtcConfig = {
      iceServers: [
        { urls: "stun:stun.l.google.com:19302" }
      ]
    };

    function setCallUi(active) {
      inCall = active;
      hangupBtn.disabled = !active;
      setCallState(active ? "In callâ€¦" : "No call");
    }

    function showIncoming(show) {
      incomingEl.style.display = show ? "flex" : "none";
    }

    async function ensurePeerConnection() {
      if (pc) return pc;

      pc = new RTCPeerConnection(rtcConfig); // [web:754]

      pc.onicecandidate = (event) => {
        if (event.candidate) {
          socket.emit("call:ice", { candidate: event.candidate });
        }
      }; // [web:795]

      pc.ontrack = (event) => {
        if (event.streams && event.streams[0]) {
          remoteAudio.srcObject = event.streams[0];
        }
      };

      return pc;
    }

    async function startLocalAudio() {
      if (localStream) return localStream;
      localStream = await navigator.mediaDevices.getUserMedia({ audio: true }); // [web:761]
      return localStream;
    }

    async function addLocalTracks() {
      const pc = await ensurePeerConnection();
      const stream = await startLocalAudio();
      stream.getTracks().forEach((t) => pc.addTrack(t, stream));
    }

    function cleanupCall() {
      setCallUi(false);
      showIncoming(false);
      pendingOffer = null;

      if (pc) {
        pc.onicecandidate = null;
        pc.ontrack = null;
        pc.close();
        pc = null;
      }

      if (localStream) {
        localStream.getTracks().forEach((t) => t.stop());
        localStream = null;
      }

      pendingIce = [];
      remoteAudio.srcObject = null;
    }

    socket.on("call:offer", ({ sdp, from } = {}) => {
      if (!sdp) return;
      if (inCall) {
        // already in a call: reject by hanging up
        socket.emit("call:hangup", {});
        return;
      }
      pendingOffer = { sdp, from: from || "unknown" };
      showIncoming(true);
      setCallState("Incoming callâ€¦");
      addBubble("them", "Incoming callâ€¦");
    });

    acceptBtn.addEventListener("click", async () => {
      try {
        if (!pendingOffer?.sdp) return;

        setCallUi(true);
        showIncoming(false);
        setCallState("Connectingâ€¦");

        await ensurePeerConnection();
        await addLocalTracks();

        await pc.setRemoteDescription(pendingOffer.sdp); // [web:793]

        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer); // [web:792]

        socket.emit("call:answer", { sdp: pc.localDescription });

        for (const c of pendingIce) await pc.addIceCandidate(c);
        pendingIce = [];

        setCallState("Connected");
        addBubble("me", "Call connected");
      } catch (e) {
        addBubble("me", `Call accept failed: ${e.message}`);
        cleanupCall();
      }
    });

    rejectBtn.addEventListener("click", () => {
      socket.emit("call:hangup", {});
      addBubble("me", "Call rejected");
      cleanupCall();
    });

    hangupBtn.addEventListener("click", () => {
      socket.emit("call:hangup", {});
      addBubble("me", "Call ended");
      cleanupCall();
    });

    socket.on("call:answer", async () => {
      // Customer is callee; should not receive answer in normal flow, ignore safely
    });

    socket.on("call:ice", async ({ candidate } = {}) => {
      try {
        if (!candidate) return;
        if (!pc || !pc.remoteDescription) {
          pendingIce.push(candidate);
          return;
        }
        await pc.addIceCandidate(candidate);
      } catch (e) {
        addBubble("me", `ICE error: ${e.message}`);
      }
    });

    socket.on("call:hangup", ({ from } = {}) => {
      cleanupCall();
      addBubble("them", `Call ended${from ? ` by ${from}` : ""}`);
    });

    // ---------------- Socket.IO connect + chat ----------------
    socket.on("connect", () => {
      setStatus("Connected");
      socket.emit("join", { room, role });
    });

    socket.on("disconnect", () => setStatus("Disconnected"));

    socket.on("chat", (m) => {
      const side = (m.from === role) ? "me" : "them";
      const ts = m.ts || Date.now();

      let obj = null;
      try { obj = JSON.parse(m.text); } catch {}

      if (obj?.type === "media" && typeof obj.audioUrl === "string") {
        addMediaGroup(side, obj, ts);
      } else {
        addBubble(side, m.text, ts);
      }
    });

    sendBtn.addEventListener("click", sendCurrent);
    inputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter") sendCurrent();
    });

    uploadBtn.addEventListener("click", () => fileEl.click());
    fileEl.addEventListener("change", uploadSelectedFile);
  </script>
</body>
</html>
